---
import { ClientRouter } from 'astro:transitions';
---

<header transition:persist="none">
	<ClientRouter />
	<a href="/" class="logo">
		<img src="/luglogo.png" alt="logo">
		<span>The LUGVITC Blog</span>
	</a>
	<button id="menu-toggle" aria-label="Toggle menu">
		<svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
			<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
		</svg>
	</button>
	<nav id="nav-menu">
		<a href="/">cd ~</a>
		<a href="https://www.lugvitc.net">cd /</a>
		<a href="https://lugvitc.net/#/contact">ping port:80</a>
		<button id="nav-theme-toggle" class="nav-theme-toggle">
			<img src="/Sun.svg" alt="Theme Icon">
			<span>Light</span>
		</button>
	</nav>
	<button id="toggle-theme" aria-label="Toggle theme"><img src="/Sun.svg" alt="Toggle theme"></button>
</header>

<script is:inline>
	const getTheme = () => {
		if (localStorage.getItem("theme")) {
			return localStorage.getItem("theme");
		}
		if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
			return "dark";
		}
		return "light";
	};

	const applyTheme = (theme) => {
		document.documentElement.classList.toggle("dark", theme === "dark");
	};

	const updateIcon = (theme) => {
		const icon = document.querySelector("#toggle-theme img");
		if (icon) {
			icon.src = theme === "dark" ? "/Sun.svg" : "/Moon.svg";
		}
		const navBtn = document.getElementById("nav-theme-toggle");
		if (navBtn) {
			const navIcon = navBtn.querySelector("img");
			const navSpan = navBtn.querySelector("span");
			if (navIcon) navIcon.src = theme === "dark" ? "/Sun.svg" : "/Moon.svg";
			if (navSpan) navSpan.innerText = theme === "dark" ? "Light" : "Dark";
		}
	};

	const handleToggleClick = () => {
		document.documentElement.classList.add("disable-transitions");

		const isDark = document.documentElement.classList.toggle("dark");
		const theme = isDark ? "dark" : "light";

		localStorage.setItem("theme", theme);
		updateIcon(theme);

		window.setTimeout(() => {
			document.documentElement.classList.remove("disable-transitions");
		}, 0);
	};

	const theme = getTheme();
	applyTheme(theme);
	updateIcon(theme);
	localStorage.setItem("theme", theme);

	const attachToggle = () => {
		const btn = document.getElementById("toggle-theme");
		if (btn) {
			btn.onclick = handleToggleClick;
		}
		const navBtn = document.getElementById("nav-theme-toggle");
		if (navBtn) {
			navBtn.onclick = handleToggleClick;
		}
	};

	const attachMenuToggle = () => {
		const menuBtn = document.getElementById("menu-toggle");
		const nav = document.getElementById("nav-menu");
		
		if (menuBtn && nav) {
			menuBtn.onclick = () => {
				const isExpanded = nav.classList.toggle("expanded");
				menuBtn.setAttribute("aria-expanded", isExpanded);
			};
		}
	};
	
	if (!window.themeListenersAttached) {
		document.addEventListener("astro:after-swap", () => {
			applyTheme(getTheme());
			updateIcon(getTheme());
	});

	document.addEventListener("astro:page-load", () => {
			attachToggle();
			attachMenuToggle();
			applyTheme(getTheme());
	});
	
	window.themeListenersAttached = true;
	}
</script>

<style>
	header {
		display:flex;
		align-items: center;
		position: relative;
		gap: 2rem;
		padding:0.1rem 0.5rem;
		border-bottom:4px solid var(--header-border);
		color: white;
		background: var(--header-bg);
	}

	.logo {
		display: flex;
		align-items: center;
		text-decoration:none;
		color:inherit;
		padding: 4px;
	}
	.logo img {
		height: 80px;
		width: auto;
	}

	.logo span {
		font-weight: 400;
		letter-spacing: 0.05em;
		line-height: 1;
		border:2px solid var(--color-border);
		padding:12px;
		background:var(--gray);
		box-shadow: 6px 6px var(--box-shadow);
	}

	nav {
		width: auto;
		display:flex;
		gap:2rem;
		margin-left: auto;
	}

	nav a {
		text-decoration:none;
		color: inherit;
		padding: 0.5rem 2.5rem;
		box-shadow: 6px 6px var(--box-shadow);
	}

	nav a:nth-child(1) {
		background: var(--color-orange); 
	}

	nav a:nth-child(2) {
		background: var(--color-blue); 
	}

	nav a:nth-child(3) {
		background: var(--color-green); 
	}

	#nav-theme-toggle {
		display: none;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		text-decoration:none;
		color: inherit;
		padding: 0.5rem 2.5rem;
		box-shadow: 6px 6px var(--box-shadow);
		background: var(--color-orange);
		border: none;
		border-radius: 0;
		cursor: pointer;
		font-family: inherit;
		font-size: inherit;
	}

	#nav-theme-toggle img {
		width: 24px;
		height: 24px;
	}

	#toggle-theme {
		display:flex;
		align-items:center;
		justify-content: center;
		padding:0.5rem 0.5rem;
		background: var(--color-orange);
		box-shadow: 6px 6px var(--box-shadow);
		margin-right: 12px;
		border: none;
		border-radius: 0;
		cursor: pointer;
	}

	#toggle-theme img {
		width: 32px;
		height: 32px;
	}

	header nav a,
	#toggle-theme,
	#nav-theme-toggle {
	transition:
		transform 0.15s ease-out,
		box-shadow 0.15s ease-out;
	}

	header nav a:hover, #toggle-theme:hover, #nav-theme-toggle:hover {
		transform: translate(1px, 1px);
		box-shadow: 4px 4px var(--box-shadow);
	}

	#menu-toggle {
		display: none;
		align-items: center;
		justify-content: center;
		background: var(--gray);
		border: none;
		border-radius: 0;
		color: white;
		cursor: pointer;
		padding: 0.5rem 0.5rem;
		margin-left: auto;
		box-shadow: 6px 6px var(--box-shadow);
		transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
	}

	#menu-toggle:hover {
		transform: translate(1px, 1px);
		box-shadow: 4px 4px var(--box-shadow);
	}

	@media (max-width: 1124px) {
		.logo img {
			height: 48px;
		}
		.logo span {
			font-size: 0.9em;
			padding: calc(0.5rem - 2px) 0.5rem;
			line-height: 1.5;
		}
		nav a {
			padding: 0.5rem 0.75rem;
			font-size: 0.9em;
			white-space: nowrap;
			line-height: 1.5;
		}
		nav {
			gap: 1.5rem;
		}
		header {
			padding-bottom: 0.75rem;
			gap: 1.5rem;
		}
		#toggle-theme img {
			width: 27px;
			height: 27px;
		}
	}

	@media (max-width: 820px) {
		#nav-theme-toggle {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			
			width: 50%;
			box-sizing: border-box;
			padding: 0.5rem;
			font-size: 1.25rem;
			box-shadow: 4px 4px var(--box-shadow);
		}

		#toggle-theme {
			display: none !important;
		}

		#menu-toggle {
			display: flex;
			width: 3rem;
			height: 3rem;
			aspect-ratio: 1 / 1; 
			
			padding: 0;
			justify-content: center;
			align-items: center;
			
			flex: 0 0 auto;
			box-sizing: border-box;
			box-shadow: 4px 4px var(--box-shadow);
			margin-left: auto;
		}
		
		header {
			justify-content: space-between;
			padding: 0.5rem;
		}

		.logo {
			gap: 0.5rem;
			overflow: hidden;
		}

		.logo img {
			height: 3rem;
			width: auto;
		}

		.logo span {
			font-size: 0.9em;
			padding: calc(0.5rem - 2px) 0.5rem;
			line-height: 1.5;
		}
		

		nav {
			display: none;
			position: absolute;
			top: 100%;
			left: -0.5rem;
			
			flex-direction: column;
			align-items: center;
			justify-content: space-evenly;
			
			background: var(--header-bg);
			border-top: 4px solid var(--header-border);
			border-bottom: 4px solid var(--header-border);

			padding: 1.5rem 1rem;
			z-index: 100;
			width: calc(100% + 1rem);
			max-width: none;
			
			box-sizing: border-box;
			margin: 0;
			
			transform-origin: top center;
			animation: menu-slide-down 0.3s ease-in-out forwards;
		}

		@keyframes menu-slide-down {
			0% { opacity: 0; transform: scaleY(0); }
			100% { opacity: 1; transform: scaleY(1); }
		}

		nav.expanded {
			display: flex;
		}

		nav a {
			width: 50%;
			text-align: center;
			box-sizing: border-box;
			padding: 0.5rem;
			font-size: 1.25rem;
			
			box-shadow: 4px 4px var(--box-shadow);
		}
		
		header nav a:hover,
		#menu-toggle:hover,
		#nav-theme-toggle:hover {
			transform: none;
			cursor: default;
			box-shadow: 4px 4px var(--box-shadow);
		}
	}
</style>
