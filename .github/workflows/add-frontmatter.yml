name: Add frontmatter

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/content/**.md'
      - 'src/content/**.mdx'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-frontmatter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install gray-matter

      - name: Get PR files and author id
        id: pr_files
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return { paths: [], author_id: null };

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            );

            const paths = files
              .map(f => f.filename)
              .filter(p => p.startsWith('src/content/')
              && (p.endsWith('.md') || p.endsWith('.mdx'))
              );

            return {
              paths,
              author_id: pr.user.id,
            };

      - name: Run update-frontmatter for changed/added files
        if: ${{ steps.pr_files.outputs.result != '' }}
        env:
          PR_RESULT: ${{ steps.pr_files.outputs.result }}
        run: |
          node -e '
          const r = JSON.parse(process.env.PR_RESULT || "{}");
          const paths = r.paths || [];
          const author = r.author_id;

          if (!author || paths.length === 0) {
            console.log("No content files changed or author missing; skipping.");
            process.exit(0);
          }

          const { spawnSync } = require("child_process");
          const url = `https://avatars.githubusercontent.com/u/${author}`;

          for (const p of paths) {
            console.log("Processing", p);
            const res = spawnSync(
              "node",
              ["scripts/update-frontmatter.cjs", p, url],
              { stdio: "inherit" }
            );
            if (res.status !== 0) process.exit(res.status);
          }
          '

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: 'src'
          message: 'chore: auto-update frontmatter'
          default_author: github_actions
          push: true
